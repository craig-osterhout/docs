{{- /*
  This template recursively renders the sidebar navigation, grouping pages by `Params.sidebar.groups`.
  Highlights:
  - Supports hierarchical navigation with collapsible sections (`renderList` template).
  - Dynamically applies current page highlighting and expanded states.
  - Handles external links via `Params.sidebar.goto` in `renderSingle`.
  - Requires `Params.sitemap` and `Params.sidebar` for filtering and behavior.
*/ -}}
<!-- section tree -->
<nav class="navbar-font flex flex-col">
  <div class="block py-4 text-gray-200 md:hidden dark:text-gray-200">
    This section
  </div>
  <ul>
    {{- $first := .FirstSection }}
    {{- if eq $first.Title "Manuals" }}
      {{- if eq page $first }}
        {{/* 1) On /manuals/ → list all manuals, grouped by Params.sidebar.groups (multi-group supported) */}}
        {{- $sections := $first.Sections }}
        {{- /* Manuals without any group */}}
        {{- $ungrouped := where $sections "Params.sidebar.group" "==" nil }}
        {{- range $ungrouped }}
          {{ template "renderSingle" . }}
        {{- end }}
        {{- /* Then each declared group, allowing multiple groups per manual */}}
        {{- range $group := $first.Params.sidebar.groups }}
          <div class="navbar-group">
            <li class="navbar-group-font-title">{{ $group }}</li>
            {{- range $sections }}
              {{- if in .Params.sidebar.group $group }}
                {{ template "renderSingle" . }}
              {{- end }}
            {{- end }}
          </div>
        {{- end }}
      {{- else }}
        {{/* 2) Under a specific manual → render that manual’s full collapsible tree */}}
        {{- range $first.Sections }}
          {{- if or (eq page .) (page.IsDescendant .) }}
            {{ template "renderList" . }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- else }}
      {{/* 3) Everywhere else → normal recursive nav of FirstSection */}}
      {{ template "renderChildren" $first }}
    {{- end }}
  </ul>
</nav>

{{ define "renderChildren" }}
  {{- $pages := where .Pages "Params.sitemap" "ne" "false" }}
  {{- if .Params.sidebar.reverse }}
    {{ $pages = .Pages.Reverse }}
  {{- end }}
  {{- $ungrouped := where $pages "Params.sidebar.group" "==" nil }}
  {{- range $ungrouped }}
    {{- if .IsSection }}
      {{- template "renderList" . }}
    {{- else }}
      {{- template "renderSingle" . }}
    {{- end }}
  {{- end }}
  {{- /* grouping, allowing multiple groups per page */}}
  {{- range $group := .Params.sidebar.groups }}
    <div class="navbar-group">
      <li class="navbar-group-font-title">{{ $group }}</li>
      {{- range $pages }}
        {{- if in .Params.sidebar.group $group }}
          {{- if .IsSection }}
            {{- template "renderList" . }}
          {{- else }}
            {{- template "renderSingle" . }}
          {{- end }}
        {{- end }}
      {{- end }}
    </div>
  {{- end }}
{{ end }}

{{/* Recursive template for sidebar items */}}
{{ define "renderList" }}
  {{ $isCurrent := eq page . }}
  {{ $expanded := or $isCurrent (page.IsDescendant .) }}
  <li x-data="{ expanded: {{ $expanded }} }">
    <div class="{{ if $isCurrent }}navbar-entry-background-current{{ end }}
                flex w-full items-center justify-between rounded-sm">
      <div class="navbar-entry-margin w-full truncate">
        {{- if .Permalink }}
          <a
            {{ if $isCurrent }}aria-current="page" id="sidebar-current-page"{{ end }}
            class="hover:text-blue block select-none hover:dark:text-blue-400"
            href="{{ .Permalink }}"
          >
            {{ template "renderTitle" . }}
          </a>
        {{- else }}
          <button
            @click="expanded = !expanded"
            class="hover:text-blue w-full text-left select-none hover:dark:text-blue-400"
          >
            {{ template "renderTitle" . }}
          </button>
        {{- end }}
      </div>
      <button @click="expanded = !expanded"
              class="rounded-sm hover:bg-gray-200 hover:dark:bg-gray-800">
        <span :class="{ 'hidden': expanded }"
              class="icon-svg {{ if $expanded }}hidden{{ end }}">
          {{ partialCached "icon" "arrow_drop_down" "arrow_drop_down" }}
        </span>
        <span :class="{ 'hidden': !expanded }"
              class="icon-svg {{ if not $expanded }}hidden{{ end }}">
          {{ partialCached "icon" "arrow_drop_up" "arrow_drop_up" }}
        </span>
      </button>
    </div>
    <ul :class="{ 'hidden': !expanded }"
        class="{{ if not $expanded }}hidden{{ end }} ml-3">
      {{ template "renderChildren" . }}
    </ul>
  </li>
{{ end }}

{{ define "renderSingle" }}
  {{- if .Params.sidebar.goto }}
    <li class="navbar-entry-margin hover:text-blue hover:dark:text-blue-400">
      <a
        class="block w-full truncate"
        href="{{ .Params.sidebar.goto }}"
        title="{{ .LinkTitle }}"
      >
        {{ template "renderTitle" . }}
      </a>
    </li>
  {{- else }}
    {{ $isCurrent := eq page . }}
    <li class="navbar-entry-margin hover:text-blue {{ if $isCurrent }}navbar-entry-background-current{{ end }} rounded-sm hover:dark:text-blue-400">
      <a
        {{ if $isCurrent }}aria-current="page" id="sidebar-current-page"{{ end }}
        class="block w-full truncate"
        href="{{ .Permalink }}"
        title="{{ .LinkTitle }}"
      >
        {{ template "renderTitle" . }}
      </a>
    </li>
  {{- end }}
{{ end }}

{{ define "renderTitle" }}
  {{ .LinkTitle }}
  {{- with .Params.sidebar.badge }}
    <span>
      {{ partial "components/badge.html" (dict "color" .color "content" .text) }}
    </span>
  {{- end }}
{{ end }}
